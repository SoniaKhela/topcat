(function(){angular.module("app.controllers").controller("OpenDataModalController",function(n,t,i,r){var h,u,e,f,s,o;return h=function(n){var t,i,r;return r=n.getFullYear(),i=o(n.getMonth()+1),t=o(n.getDate()),""+t+"/"+i+"/"+r},o=function(n){return n<10?"0"+n:n},n.assessmentRequest={},n.assessmentRequest.id=n.form.id,n.recordOutput=r,u={riskAssessment:{currentClass:{},completed:{}},signOff:{currentClass:{},completed:{},timeout:{},showButton:{}},upload:{currentClass:{},completed:{}},currentActiveView:{}},n.publishingStatus=u,u.signOff.timeout=-1,n.refreshPublishingStatus=function(){return u.riskAssessment.completed=n.form.publication!==null&&n.form.publication.openData.assessment.completed,u.signOff.completed=n.form.publication!==null&&n.form.publication.openData.signOff!==null,u.upload.completed=n.form.publication!==null&&n.form.publication.openData.lastSuccess!==null,u.riskAssessment.currentClass=n.recordOutput.publishingState.assessedAndUpToDate?"visited":u.riskAssessment.completed?"current":"current",u.signOff.currentClass=n.recordOutput.publishingState.signedOffAndUpToDate?"visited":n.recordOutput.publishingState.assessedAndUpToDate?"current":"disabled",u.upload.currentClass=n.recordOutput.publishingState.uploadedAndUpToDate?"visited":n.recordOutput.publishingState.signedOffAndUpToDate?"current":"disabled"},n.refreshPublishingStatus(),u.currentActiveView=n.recordOutput.publishingState.signedOffAndUpToDate?"upload":n.recordOutput.publishingState.assessedAndUpToDate?"sign off":"risk assessment",e=function(){if(n.form.publication!==null&&n.form.publication.openData.assessment.completed)return n.assessmentCompletedInfo=n.form.publication.openData.assessment.completedByUser===null&&n.form.publication.openData.assessment.initialAssessmentWasDoneOnSpreadsheet?"Initial assessment completed on spreadsheet":n.recordOutput.publishingState.assessedAndUpToDate?"Completed by "+n.form.publication.openData.assessment.completedByUser.displayName+" on "+moment(new Date(n.form.publication.openData.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a"):"Last completed by "+n.form.publication.openData.assessment.completedByUser.displayName+" on "+moment(new Date(n.form.publication.openData.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a")},f=function(){return u.signOff.showButton=n.user.isIaoUser&&!n.recordOutput.publishingState.signedOffAndUpToDate,n.form.publication!==null&&n.form.publication.openData.signOff!==null&&(n.signOffCompletedInfo=n.form.publication.openData.signOff.user===null?"Initial sign off completed on spreadsheet":n.recordOutput.publishingState.signedOffAndUpToDate?"Signed off by "+n.form.publication.openData.signOff.user.displayName+" on "+moment(new Date(n.form.publication.openData.signOff.dateUtc)).format("DD MMM YYYY h:mm a"):"Last signed off by "+n.form.publication.openData.signOff.user.displayName+" on "+moment(new Date(n.form.publication.openData.signOff.dateUtc)).format("DD MMM YYYY h:mm a")),u.signOff.signOffButtonText=n.user.isIaoUser?"SIGN OFF":"Pending sign off"},s=function(){return n.form.publication!==null&&(n.form.publication.openData.lastAttempt!==null&&(n.uploadLastAttempted=moment(new Date(n.form.publication.openData.lastAttempt.dateUtc)).format("DD MMM YYYY h:mm a")),n.form.publication.openData.lastSuccess!==null&&(n.uploadLastSucceeded=moment(new Date(n.form.publication.openData.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a"))),n.uploadStatus=n.recordOutput.publishingState.uploadedAndUpToDate?"Upload completed":"Pending upload"},e(),f(),s(),n.assessButtonClick=function(){return t.put("../api/publishing/opendata/assess",n.assessmentRequest).success(function(t){return n.status.refresh(),n.form=t.recordOutputModel.record,n.recordOutput=t.recordOutputModel,e(),n.refreshPublishingStatus(),u.currentActiveView="sign off"})["catch"](function(t){return n.notifications.add(t.data.exceptionMessage),n.$dismiss()})},n.signOffButtonClick=function(){return u.signOff.timeout===-1?(u.signOff.timeout=10,n.allowGraceTime()):n.cancelSignOff()},n.submitSignOff=function(){return n.signOffRequest={id:n.form.id,comment:""},t.put("../api/publishing/opendata/signoff",n.signOffRequest).success(function(t){return n.form=t.recordOutputModel.record,n.recordOutput=t.recordOutputModel,n.status.refresh(),f(),n.refreshPublishingStatus(),u.currentActiveView="upload"})["catch"](function(t){return t.status===401?n.notifications.add("Unauthorised - not in valid sign off group"):n.notifications.add(t.data.exceptionMessage),u.signOff.timeout=-1,n.$dismiss()})},n.allowGraceTime=function(){return u.signOff.timeout>0?(u.signOff.signOffButtonText="Cancel "+("0"+u.signOff.timeout--).slice(-2),i(n.allowGraceTime,1e3)):u.signOff.timeout===0?(i.cancel,n.submitSignOff()):void 0},n.cancelSignOff=function(){return i.cancel,u.signOff.timeout=-1,f()},n.close=function(){return n.$close(n.recordOutput)}})}).call(this);