(function(){angular.module("app.controllers").controller("OpenDataModalController",function(n,t,i){var s,r,f,u,o,e;return s=function(n){var t,i,r;return r=n.getFullYear(),i=e(n.getMonth()+1),t=e(n.getDate()),""+t+"/"+i+"/"+r},e=function(n){return n<10?"0"+n:n},n.assessmentRequest={},n.assessmentRequest.id=n.form.id,r={riskAssessment:{currentClass:{},completed:{}},signOff:{currentClass:{},completed:{},timeout:{},showButton:{}},upload:{currentClass:{},completed:{}},currentActiveView:{}},n.publishingStatus=r,r.signOff.timeout=-1,n.refreshPublishingStatus=function(){return r.riskAssessment.completed=n.form.publication!==null&&n.form.publication.openData.assessment.completed,r.signOff.completed=n.form.publication!==null&&n.form.publication.openData.signOff!==null,r.upload.completed=n.form.publication!==null&&n.form.publication.openData.lastSuccess!==null,r.riskAssessment.currentClass=n.isAssessedAndUpToDate(n.form)?"visited":r.riskAssessment.completed?"current":"current",r.signOff.currentClass=n.isSignedOffAndUpToDate(n.form)?"visited":n.isAssessedAndUpToDate(n.form)?"current":"disabled",r.upload.currentClass=n.isUploadedAndUpToDate(n.form)?"visited":n.isSignedOffAndUpToDate(n.form)?"current":"disabled"},n.refreshPublishingStatus(),r.currentActiveView=n.isSignedOffAndUpToDate(n.form)?"upload":n.isAssessedAndUpToDate(n.form)?"sign off":"risk assessment",f=function(){if(n.form.publication!==null&&n.form.publication.openData.assessment.completed)return n.assessmentCompletedInfo=n.form.publication.openData.assessment.completedBy===null&&n.form.publication.openData.assessment.initialAssessmentWasDoneOnSpreadsheet?"Initial assessment completed on spreadsheet":n.isAssessedAndUpToDate(n.form)?"Completed by "+n.form.publication.openData.assessment.completedByUser.displayName+" on "+moment(new Date(n.form.publication.openData.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a"):"Last completed by "+n.form.publication.openData.assessment.completedByUser.displayName+" on "+moment(new Date(n.form.publication.openData.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a")},u=function(){return r.signOff.showButton=n.user.isIaoUser&&!n.isSignedOffAndUpToDate(n.form),n.form.publication!==null&&n.form.publication.openData.signOff!==null&&(n.signOffCompletedInfo=n.form.publication.openData.signOff.user===null?"Initial sign off completed on spreadsheet":n.isSignedOffAndUpToDate(n.form)?"Signed off by "+n.form.publication.openData.signOff.user.displayName+" on "+moment(new Date(n.form.publication.openData.signOff.dateUtc)).format("DD MMM YYYY h:mm a"):"Last signed off by "+n.form.publication.openData.signOff.user.displayName+" on "+moment(new Date(n.form.publication.openData.signOff.dateUtc)).format("DD MMM YYYY h:mm a")),r.signOff.signOffButtonText=n.user.isIaoUser?"SIGN OFF":"Pending sign off"},o=function(){return n.form.publication!==null&&(n.form.publication.openData.lastAttempt!==null&&(n.uploadLastAttempted=moment(new Date(n.form.publication.openData.lastAttempt.dateUtc)).format("DD MMM YYYY h:mm a")),n.form.publication.openData.lastSuccess!==null&&(n.uploadLastSucceeded=moment(new Date(n.form.publication.openData.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a"))),n.uploadStatus=n.isUploadedAndUpToDate(n.form)?"Upload completed":"Pending upload"},f(),u(),o(),n.assessButtonClick=function(){return t.put("../api/publishing/opendata/assess",n.assessmentRequest).success(function(t){return n.status.refresh(),n.form=t.record,f(),n.refreshPublishingStatus(),r.currentActiveView="sign off"})["catch"](function(t){return n.notifications.add(t.data.exceptionMessage),n.$dismiss()})},n.signOffButtonClick=function(){return r.signOff.timeout===-1?(r.signOff.timeout=10,n.allowGraceTime()):n.cancelSignOff()},n.submitSignOff=function(){return n.signOffRequest={id:n.form.id,comment:""},t.put("../api/publishing/opendata/signoff",n.signOffRequest).success(function(t){return n.status.refresh(),n.form=t.record,u(),n.refreshPublishingStatus(),r.currentActiveView="upload"})["catch"](function(t){return t.status===401?n.notifications.add("Unauthorised - not in valid sign off group"):n.notifications.add(t.data.exceptionMessage),r.signOff.timeout=-1,n.$dismiss()})},n.allowGraceTime=function(){return r.signOff.timeout>0?(r.signOff.signOffButtonText="Cancel "+("0"+r.signOff.timeout--).slice(-2),i(n.allowGraceTime,1e3)):r.signOff.timeout===0?(i.cancel,n.submitSignOff()):void 0},n.cancelSignOff=function(){return i.cancel,r.signOff.timeout=-1,u()},n.close=function(){return n.$close(n.form)}})}).call(this);