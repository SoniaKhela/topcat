(function(){angular.module("app.controllers").controller("OpenDataModalController",function(n,t,i){var f,r,e,u,o;return f=function(n){var t,i,r;return r=n.getFullYear(),i=o(n.getMonth()+1),t=o(n.getDate()),""+t+"/"+i+"/"+r},o=function(n){return n<10?"0"+n:n},n.assessmentRequest={},n.assessmentRequest.id=n.form.id,r={riskAssessment:{currentClass:{},completed:{}},signOff:{currentClass:{},completed:{},timeout:{},signOffButtonDisabled:{},signOffButtonClass:{}},upload:{currentClass:{},completed:{}},currentActiveView:{}},n.publishingStatus=r,r.signOff.timeout=0,n.refreshPublishingStatus=function(){return r.riskAssessment.completed=n.form.publication!==null&&n.form.publication.openData.assessment.completed,r.signOff.completed=n.form.publication!==null&&n.form.publication.openData.signOff!==null,r.upload.completed=n.form.publication!==null&&n.form.publication.openData.lastSuccess!==null,r.upload.completed?(r.riskAssessment.currentClass="visited",r.signOff.currentClass="visited",r.upload.currentClass="visited"):r.signOff.completed?(r.riskAssessment.currentClass="visited",r.signOff.currentClass="visited",r.upload.currentClass="current"):r.riskAssessment.completed?(r.riskAssessment.currentClass="visited",r.signOff.currentClass="current",r.upload.currentClass="disabled"):(r.riskAssessment.currentClass="current",r.signOff.currentClass="disabled",r.upload.currentClass="disabled")},n.refreshPublishingStatus(),r.currentActiveView=r.upload.completed||r.signOff.completed?"upload":r.riskAssessment.completed?"sign off":"risk assessment",e=function(){return n.assessmentButtonText=n.form.publication!==null&&n.form.publication.openData.assessment.completed?n.form.publication.openData.assessment.initialAssessmentWasDoneOnSpreadsheet?"Initial assessment completed on spreadsheet":"Completed by "+n.form.publication.openData.assessment.completedByUser.displayName+" on "+f(new Date(n.form.publication.openData.assessment.completedOnUtc)):"I AGREE"},u=function(){return r.signOff.signOffButtonDisabled=!n.user.isIaoUser||n.form.publication!==null&&n.form.publication.openData.signOff!==null,n.form.publication!==null&&n.form.publication.openData.signOff!==null?(r.signOff.signOffButtonClass="btn btn-primary",r.signOff.signOffButtonText="Signed off by "+n.form.publication.openData.signOff.user.displayName+" on "+f(new Date(n.form.publication.openData.signOff.dateUtc))):n.user.isIaoUser?(r.signOff.signOffButtonClass="btn btn-danger sign-off",r.signOff.signOffButtonText="SIGN OFF"):(r.signOff.signOffButtonClass="btn btn-primary",r.signOff.signOffButtonText="Pending sign off")},e(),u(),n.assessClick=function(){return t.put("../api/publishing/opendata/assess",n.assessmentRequest).success(function(t){return n.status.refresh(),n.form=t.record,e(),n.refreshPublishingStatus(),r.currentActiveView="sign off"})["catch"](function(t){return n.notifications.add(t.data.exceptionMessage),n.$dismiss()})},n.submitSignOff=function(){return n.signOffRequest={id:n.form.id,comment:""},t.put("../api/publishing/opendata/signoff",n.signOffRequest).success(function(t){return n.status.refresh(),n.form=t.record,u(),n.refreshPublishingStatus(),r.currentActiveView="upload"})["catch"](function(t){return t.status===401?n.notifications.add("Unauthorised - not in valid sign off group"):n.notifications.add(t.data.exceptionMessage),r.signOff.timeout=0,n.$dismiss()})},n.allowGraceTime=function(){return r.signOff.timeout>0?(r.signOff.signOffButtonText="Cancel "+("0"+r.signOff.timeout--).slice(-2),i(n.allowGraceTime,1e3)):n.submitSignOff()},n.cancelSignOff=function(){return r.signOff.timeout=0,u()},n.signOffButtonClick=function(){return r.signOff.timeout===0?(r.signOff.timeout=10,n.allowGraceTime()):n.cancelSignOff()},n.close=function(){return n.$close(n.form)}})}).call(this);