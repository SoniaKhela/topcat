(function(){var t,n,i;angular.module("app.controllers").controller("OpenDataModalController",function(r,u,f){var l,e,s,o,c,h;return l=function(n){var t,i,r;return r=n.getFullYear(),i=h(n.getMonth()+1),t=h(n.getDate()),""+t+"/"+i+"/"+r},h=function(n){return n<10?"0"+n:n},r.assessmentRequest={},r.assessmentRequest.id=r.form.id,r.isAssessedAndUpToDate=t,r.isSignedOffAndUpToDate=n,r.isUploadedAndUpToDate=i,e={riskAssessment:{currentClass:{},completed:{}},signOff:{currentClass:{},completed:{},timeout:{},showButton:{}},upload:{currentClass:{},completed:{}},currentActiveView:{}},r.publishingStatus=e,e.signOff.timeout=-1,r.refreshPublishingStatus=function(){return e.riskAssessment.completed=r.form.publication!==null&&r.form.publication.openData.assessment.completed,e.signOff.completed=r.form.publication!==null&&r.form.publication.openData.signOff!==null,e.upload.completed=r.form.publication!==null&&r.form.publication.openData.lastSuccess!==null,e.riskAssessment.currentClass=t(r.form)?"visited":e.riskAssessment.completed?"current":"current",e.signOff.currentClass=n(r.form)?"visited":t(r.form)?"current":"disabled",e.upload.currentClass=i(r.form)?"visited":n(r.form)?"current":"disabled"},r.refreshPublishingStatus(),e.currentActiveView=n(r.form)?"upload":t(r.form)?"sign off":"risk assessment",s=function(){if(r.form.publication.openData.assessment.completed)return r.form.publication.openData.assessment.initialAssessmentWasDoneOnSpreadsheet?(r.assessmentCompletedByUser="Initial assessment completed on spreadsheet",r.assessmentCompletedOnDate=null):t(r.form)?(r.assessmentCompletedByUser="Completed by: "+r.form.publication.openData.assessment.completedByUser.displayName,r.assessmentCompletedOnDate="Completed on: "+moment(new Date(r.form.publication.openData.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a")):(r.assessmentCompletedByUser="Last completed by: "+r.form.publication.openData.assessment.completedByUser.displayName,r.assessmentCompletedOnDate="Last completed on: "+moment(new Date(r.form.publication.openData.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a"))},o=function(){return e.signOff.showButton=r.user.isIaoUser&&!n(r.form),r.form.publication.openData.signOff!==null&&(r.form.publication.openData.signOff.user===null?(r.signOffCompletedByUser="Initial sign off completed on spreadsheet",r.signOffCompletedOnDate=null):n(r.form)?(r.signOffCompletedByUser="Signed off by: "+r.form.publication.openData.signOff.user.displayName,r.signOffCompletedOnDate="Signed off on: "+moment(new Date(r.form.publication.openData.signOff.dateUtc)).format("DD MMM YYYY h:mm a")):(r.signOffCompletedByUser="Last signed off by: "+r.form.publication.openData.signOff.user.displayName,r.signOffCompletedOnDate="Last signed off on: "+moment(new Date(r.form.publication.openData.signOff.dateUtc)).format("DD MMM YYYY h:mm a"))),e.signOff.signOffButtonText=r.user.isIaoUser?"SIGN OFF":"Pending sign off"},c=function(){if(r.form.publication.openData.lastAttempt!==null)return r.uploadLastAttempted=moment(new Date(r.form.publication.openData.lastAttempt.dateUtc)).format("DD MMM YYYY h:mm a"),r.uploadLastSucceeded=moment(new Date(r.form.publication.openData.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a")},s(),o(),c(),r.assessButtonClick=function(){return u.put("../api/publishing/opendata/assess",r.assessmentRequest).success(function(n){return r.status.refresh(),r.form=n.record,s(),r.refreshPublishingStatus(),e.currentActiveView="sign off"})["catch"](function(n){return r.notifications.add(n.data.exceptionMessage),r.$dismiss()})},r.signOffButtonClick=function(){return e.signOff.timeout===-1?(e.signOff.timeout=10,r.allowGraceTime()):r.cancelSignOff()},r.submitSignOff=function(){return r.signOffRequest={id:r.form.id,comment:""},u.put("../api/publishing/opendata/signoff",r.signOffRequest).success(function(n){return r.status.refresh(),r.form=n.record,o(),r.refreshPublishingStatus(),e.currentActiveView="upload"})["catch"](function(n){return n.status===401?r.notifications.add("Unauthorised - not in valid sign off group"):r.notifications.add(n.data.exceptionMessage),e.signOff.timeout=-1,r.$dismiss()})},r.allowGraceTime=function(){return e.signOff.timeout>0?(e.signOff.signOffButtonText="Cancel "+("0"+e.signOff.timeout--).slice(-2),f(r.allowGraceTime,1e3)):e.signOff.timeout===0?(f.cancel,r.submitSignOff()):void 0},r.cancelSignOff=function(){return f.cancel,e.signOff.timeout=-1,o()},r.close=function(){return r.$close(r.form)}});t=function(t){return t.publication===null?!1:t.publication.openData.assessment.completed?t.publication.openData.assessment.completedOnUtc===t.gemini.metadataDate?!0:n(t):!1};n=function(n){return n.publication===null?!1:n.publication.openData.signOff!==null&&n.publication.openData.signOff.dateUtc===n.gemini.metadataDate?!0:i(n)};i=function(n){return n.publication===null?!1:n.publication.openData.lastAttempt!==null&&n.publication.openData.lastAttempt.dateUtc===n.gemini.metadataDate?!0:!1}}).call(this);