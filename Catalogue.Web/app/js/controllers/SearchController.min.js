(function(){var n=[].indexOf||function(n){for(var t=0,i=this.length;t<i;t++)if(t in this&&this[t]===n)return t;return-1};angular.module("app.controllers").controller("SearchController",function(t,i,r,u,f,e,o){var s,h,c,l,a,v;return t.app={starting:!0},f(function(){return t.app.starting=!1},500),t.result={results:{}},t.current={},t.pageSize=15,t.vocabulator={},t.resultsView="list",v=function(n){var t;return t=s(),r.search("q",n.q||null),r.search("f.keywords",n.f.keywords),r.search("p",n.p||null),r.search("o",n.o||null),r.search("f.metadataDate",n.f.metadataDate||null),r.search("f.dataFormats",n.f.dataFormats||null),r.search("f.resourceTypes",n.f.resourceTypes||null),r.search("f.manager",n.f.manager||null)},a=function(n){return u.get("../api/search?"+$.param(n,!1)).success(function(i){if(h(i.query,n))return t.result=i}).error(function(n){return t.notifications.add("Oops! "+n.message)})},l=function(n){return n.q?u.get("../api/keywords?q="+n.q).success(function(n){return t.keywordSuggestions=n}).error(function(n){return t.notifications.add("Oops! "+n.message)}):e.defer()},h=function(n,t){var i;return i={},angular.copy(t,i),t.f&&Object.keys(t.f).forEach(function(n){if(i.f[n]!==void 0&&i.f[n]!==null&&i.f[n].constructor===Array&&i.f[n].length<1)return i.f[n]=null}),angular.equals(n,i)},t.doSearch=function(n){var i,r;return v(n),n.q||n.f&&n.f.keywords&&n.f.keywords[0]||n.f.dataFormats&&n.f.dataFormats[0]||n.f.resourceTypes&&n.f.resourceTypes[0]||n.f.manager?(t.busy.start(),i=l(n),r=a(n),e.all([i,r])["finally"](function(){return t.busy.stop(),t.result.query.q?void 0:t.keywordSuggestions={}})):(t.keywordSuggestions={},t.result={})},s=function(){return{q:"",f:{keywords:[],dataFormats:[],resourceTypes:[],metadataDate:null,manager:null},p:0,n:t.pageSize,o:0}},t.sortOptions=["Most relevant","Title A-Z","Title Z-A","Newest to oldest","Oldest to newest"],t.dataFormatOptions=["Database","Spreadsheet","Documents","Geospatial","Image","Audio","Video","Other"],t.resourceTypeOptions={Dataset:"dataset",Publication:"publication",Service:"service","Non-geographic dataset":"nonGeographicDataset"},c=function(){var n;return n=r.search(),n.f&&n.f.keywords&&!$.isArray(n.f.keywords)&&(n.f.keywords=[n.f.keywords]),n.p&&(n.p=n.p*1),$.extend({},s(),n)},t.query=c(),t.$watch("query",t.doSearch,!0),t.querystring=function(){return $.param(t.query,!1)},t.dataFormatSelections=[],t.resourceTypeSelections=[],t.addOrRemoveSelection=function(n,t,i){return i||(i=[]),i.indexOf(n)!==-1?(i.splice(i.indexOf(n),1),t[n]=!1):(i.push(n),t[n]=!0)},t.removeManager=function(){return t.query.f.manager=null},t.addKeywordsToQuery=function(i){var r,o,u,f,e,c,l,h;for(t.query.f.keywords||(t.query.f.keywords=[]),h=_(i).map(t.keywordToString).partition(function(i){return n.call(t.query.f.keywords,i)>=0}).value(),o=h[0],u=h[1],f=0,c=u.length;f<c;f++)r=u[f],t.query.f.keywords.push(r);for(e=0,l=o.length;e<l;e++)r=o[e],t.notifications.add("Your query already contains the '"+t.keywordFromString(r).value+"' keyword");if(u.length)return t.query=_.merge({},s(),{f:t.query.f})},t.removeKeywordFromQuery=function(n){var i;return i=t.keywordToString(n),t.query.f.keywords.splice($.inArray(i,t.query.f.keywords),1)},t.keywordToString=function(n){var t;return t=n.vocab?n.vocab+"/"+n.value:n.value,t.replace("http://","")},t.keywordFromString=function(n){var t;return n.indexOf("/")===-1?{vocab:"",value:n}:(t=n.lastIndexOf("/"),{vocab:"http://"+n.substring(0,t),value:n.substring(t+1)})},t.openVocabulator=function(){var n;return n=o.open({controller:"VocabulatorController",templateUrl:"views/partials/vocabulator.html?"+(new Date).getTime(),size:"lg",scope:t}),n.result.then(function(n){return t.addKeywordsToQuery(n)})},t.setPage=function(n){if(n>0&&n<=t.maxPages(t.result.total,t.pageSize)+1)return t.query.p=n-1},t.range=function(n,t,i){var u,e,r,f;for(i=i===void 0?1:i,e=[],f=[],u=r=0;i>0?r<=t:r>=t;u=r+=i)f.push(e.push(u));return f},t.maxPages=function(n,t){return Math.ceil(n/t)-1},u.get("../api/collections").success(function(n){return t.collections=_.chunk(n,2)}),u.get("../api/usage").success(function(n){return t.recentModifications=n.recentlyModifiedRecords})})}).call(this);